# AI, Pathfinding, and Collision Analysis

The non-player characters (NPCs) in "La Abad√≠a del Crimen" exhibit complex behaviors driven by a state-based AI and a sophisticated pathfinding system.

## 1. The Height Buffer: The "Virtual" 3D World

The core of the system is the **Height Buffer** located at `2D8Ah`.
*   **Structure:** A 24x24 byte grid representing the current screen's floor plan.
*   **Content:** Each byte stores the **height** of the corresponding tile (e.g., `0x01` for floor, `0xFF` for a wall).
*   **Purpose:** This grid acts as the physics model for the game. Collision and visibility are calculated here, not using the graphics.

## 2. Collision Detection

Collision is implemented as **Height Checking**.
*   **Routine:** When a character tries to move, the engine compares the height of the current tile vs. the target tile.
*   **Logic:**
    *   Equal height = Walk.
    *   Target height is +1 = Step up (Stairs).
    *   Target height is too high = Wall (Blocked).
    *   Target height is too low = Drop (Blocked/Fall).

## 3. Dynamic Obstacles (Sprite Collision)

Characters do not collide with sprites directly; they collide with the **map**.
1.  **Stamping:** Before pathfinding runs, the engine "stamps" the tiles occupied by all characters in the Height Buffer with an impassable value (`28EFh`).
2.  **Pathfinding:** The AI sees these tiles as walls and routes around them.
3.  **Clearing:** After the frame updates, these temporary stamps are removed.

## 4. Pathfinding System

The game uses a two-tiered approach to navigation.

### 4.1. High-Level (Inter-Screen)
*   **Goal:** "Go to the Church."
*   **Logic:** Uses a room connection graph (`05CDh`) to determine the sequence of rooms to traverse.
*   **Output:** Sets a local target, like "Go to the north door."

### 4.2. Low-Level (Intra-Screen)
*   **Goal:** "Walk to tile (X, Y)."
*   **Algorithm:** A search algorithm (similar to A* or BFS) running at `4429h`.
*   **Operation:** Searches the **Height Buffer** for the shortest valid path of walkable tiles to the target. It marks visited nodes in the buffer (bit 7) to prevent loops.

## 5. Z-Axis Movement (Stairs)

The game simulates verticality without true 3D physics.
*   **Visuals:** As a character moves "up" in Z, their sprite is drawn higher on the screen (lower Y-coordinate).
*   **Footprint Change:** Normal characters occupy a 2x2 tile area. When on stairs, a flag shrinks their logical footprint to **1x1**. This allows them to fit onto the narrow staircase paths defined in the Height Buffer.

## 6. Character AI (`06FDh`)

Each NPC (Malaquias, Abbot, etc.) has a dedicated routine that acts as a state machine.
*   **Inputs:** Time of day (`2D81h`), current room, game flags (e.g., "Has crime happened?").
*   **Outputs:** Updates the character's current "Goal" variable.
*   **Buffer:** Movement commands generated by the AI are stored in a buffer (`073Ch`) for execution.
